define(['jquery'], function($) {
	var StatService = function(params, cb) {
		params = params || {};
		
		var queueSize = 20;
		var shownIds = {};
		var ready = {};
		var timeoutIds = {};
		
		var data = $.extend({
//			area: 'stat',
			object_type: 'organization',
			action_type: ''
		}, params);

		function queue(_id, _objectType, _objectPos) {
			var id = $(this).data('id') || _id;
			var objectType = $(this).data('type') || _objectType || data.object_type;
			var objectPos = _objectPos || null;
			var dataToSend = $.extend({}, data, {object_type: objectType});

			if (!shownIds[objectType]) shownIds[objectType] = [];

			if(id) shownIds[objectType].push({
				id: id,
				pos: objectPos
			});

			if(shownIds[objectType].length >= queueSize) {
				send(dataToSend);
			}

			clearTimeout(timeoutIds[objectType]);
			timeoutIds[objectType] = setTimeout(function() {
				send(dataToSend);
			}, 1000);
		}
		
		function send(dataToSend) {
			var objectType = dataToSend['object_type'];

			if(!shownIds[objectType] || !shownIds[objectType].length || ready[objectType] === false) {
				return;
			}
			ready[objectType] = false;

			dataToSend.ids = [];
			var data = shownIds[objectType].splice(0, queueSize);
			var object_pos = {};

			$.each(data, function (i, v) {
				dataToSend.ids.push(v.id);
				if (v.pos) object_pos[v.id] = v.pos;
			});

			ready[objectType] = true;

			if (window.za) {
				var send_za = {
					ev_type: 'stat',
					ev_category: dataToSend.action_type || null,
					object_type: objectType || null,
					object_id: dataToSend.ids || null
				};
				if (!_.isEmpty(object_pos)) send_za.object_pos = object_pos;
				za(send_za);
			}
		}
		
		cb && cb(queue);
	};

	return StatService;
});
